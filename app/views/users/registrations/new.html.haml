-# This view is the heart of the registration page...
-# Multiple actions render this view

-# States:
-#    User has connected an auth provider but has not yet completed registration
-#    User has clicked on the Sign up link
-#    User submitted registration form but there was an error

- if resource.email
  - login_link = link_to I18n.t('auth.login.link'), add_to_url(new_user_session_path, email: resource.email)
- else
  - login_link = link_to I18n.t('auth.login.link'), new_user_session_path

- if @failed
  = render 'users/registrations/failed', provider: @provider

.auth__form
  - unless @auth
    %h3.title= I18n.t('auth.signup.title', login_link: login_link).html_safe
    = render 'authentications/providers', flow: 'signup', icons: true, color: true
    .auth__or
      %hr/
      %span or

  - else # @auth
    %h2
      = render 'users/avatar', size: :thumb, user: @auth
      Hi,
      = @auth.display_name
    %p
      Not you?
      = link_to 'Reset', destroy_user_session_path, rel: :nofollow, class: 'btn btn-default btn-xs'
    %p
      We filled in some of your details from
      = succeed '.' do
        = authentication_provider_name(@auth.provider)
      Please confirm and sign up.

  - if resource_has_error? resource, :email, :taken
    .alert.alert-warning
      = I18n.t('auth.signup.email_taken', login_link: login_link).html_safe

  = simple_form_for resource, as: resource_name, url: registration_path(resource_name) do |f|
    = f.input :email, autofocus: true, required: true

    - if resource.try(:first_name).present? or resource.try(:first_name).present?
      = f.input :first_name

    - if resource.try(:last_name).present?
      = f.input :last_name

    - if @auth.blank?
      %div{class: resource.errors.empty? ? 'collapse fade' : ''}
        = f.input :password, required: true, autocomplete: 'off'
        = f.button :submit, I18n.t('auth.signup.link'), class: 'btn-primary'
    - else
      = f.button :submit, I18n.t('auth.signup.link'), class: 'btn-primary'

    .terms
      / By joining, you agree to the
      / = link_to 'Terms of Service', tos_page_path, target: '_blank'
      / and
      / = link_to 'Privacy Policy', privacy_page_path, target: '_blank'

    .auth__links
      = I18n.t('auth.signup.help', login_link: login_link).html_safe

  = render 'users/social/facepile'

- content_for :on_ready do
  $('input[name="user[email]"]').on('click keydown', function(){$(this).closest('form').find('.collapse').addClass('in')});
